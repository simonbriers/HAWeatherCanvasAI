# HAWeatherCanvasAI
Home Assistant weather image generator with OpenAI

# Custom Home Assistant Integration for DALL-E Image Generation

## Description
This custom integration for Home Assistant generates images using DALL-E, driven by prompts constructed from location and weather data. It combines data from Home Assistant, OpenWeatherMap, Googlemaps, and uses the OpenAI API to create unique, contextually relevant images.
Since the installed openai libary for python is the outdated 0.28, this integration makes direct calls to the latest Openai api endpoints, thus avoiding the python libary installed in HA at this moment. I didn't want the integration to forceupdate the libary to the current 1.3.5, as this would render your installation non standard and would require reinstallation on every update of HA.
Be aware that there is a small cost involved for the api calls to ChatGPT and to Dall-E. You need an Opanai account and an active payment method to be able to use their api. You can choose the model you want during setup. The tokens sent to ChatGPT are limited, the cost is negligable. To fetch a Dalle-3 image, they cost at the moment € 0.04, for Dale-2 € 0.02 per call. The difference in quality is huge however. Api calls are only made by services, up to you if you do this manually or in an automations once every ... . Every hour during night and day would be 24 calls and cost € 1 per day. Be aware, that's € 30 per month ! 1 picture per day comes down to € 1.25 per month. You have been warned ! I have a version that makes an api call to a local automatic1111 server, but this relies on that server running nonstop in you homenetwork. If someone is aware of a free Stable diffusion service, I will test and provide another version.

## Features
- **Dynamic Image Generation**: Utilizes DALL-E to generate images based on ChatGPT prompts.
- **Location Awareness**: Integrates with Googlemaps: based on your location (LongLat) fom you Home Assistant, a reverse geocache is called to Googlemaps API. You need to get you API for this. Googlemaps will return the name of the town or city, province, state and country. As this data is be passed Dalle, it is smart enough to create something that is suitable for your location. If you would live in a famous street, it could use that as well, but this information is not passed at this mooment.
- **Weather Awareness**: Integrates with OpenWeatherMap for real-time weather data and uses location data from Home Assistant.
- **Configurable via Home Assistant**: Easy setup and configuration through the Home Assistant interface.

## Prerequisites
- **Home Assistant Installation**: Ensure you have Home Assistant running on your hardware.
- **API Keys Required**:
  - **OpenAI API Key**: For accessing DALL-E services (requires a subscription plan).
  - **OpenWeatherMap API Key**: Free key for weather data, obtained after registration.
  - **Google Maps API Key**: For location services. (Reverse geocaching to retrieve our adress from your HA coordinates)

## Installation
1. **Download and Install the Integration**:
   - Place the integration files in your Home Assistant's custom components directory.
2. **Install Dependencies**:
   - Ensure `openweathermap` integration is installed and configured in Home Assistant.

## Configuration
1. **Via Home Assistant UI**:
   - Navigate to the Integrations page and add this custom integration.
   - Enter the required API keys, ChatGPT and Dall-E models when prompted.
   - As for the location name, the integration will look up the name of you location based on the longitude and Lattitude of your HA installation. You can change then ame into anything that would be more descriptive. if you live in a small town that neither ChatGPT nor Dall-E may recognize, enter a location name of the nearest city. You can even enter the name of a location in another country, and the integration will create an imga of that city with your weather and time of day situation.

2. **Configuration Parameters**:
   - `api_key_openai`: Your OpenAI API key. Used for accessing DALL-E and GPT services.
   - `api_key_openweathermap`: Your OpenWeatherMap API key. Used for fetching weather data.
   - `api_key_googlemaps`: Your Google Maps API key. Used for location services.
   - `location_name`: A default or custom location for weather and image context.
   - `image_model_name`: Choice between 'dall-e-2' and 'dall-e-3' for image generation.
   - `gpt_model_name`: Select between 'gpt-3.5-turbo' or 'gpt-4' for text generation.
  
     The choice of the ChatGPT and Dalle models is final for your installation. If you want to switch, you need to uninstall and reinstall the integration.

## Entities and Services
This integration creates two entities and provides three services:

### Entities
1. **Camera Entity - `camera.wethercanvasai_image`**:
   - This entity represents the image generated by the integration.
   - **Casting to Media Players**: The generated image can be cast to any suitable media player in your Home Assistant setup. Beware that in a docker installation, the ip adress of the container may not be included in your local network, google casting to such devices is not possible out of the box. 
   - **Use in UI**: The image, saved in /local can be displayed in the Home Assistant UI using an image card, providing a visual representation of the current weather and location scenario.

2. **Sensor Entity - `sensor.weathercanvasai_prompts`**:
   - Tracks the last used ChatGPT prompts for image generation.
   - **Attributes**:
     - `chatgpt_in`: The prompt input derived from weather and location data.
     - `chatgpt_out`: The final prompt sent to the OpenAI API for image generation.

### Services
The integration offers three services:

## Service: `load_testimage`
### Purpose
- Designed for testing the image handling and updating mechanisms of the integration.
### Functionality
- Loads a dummy image URL into the camera entity (`camera.dalle_weather_image`) for testing purposes.

## Service: `create_chatgpt_prompt`
### Purpose
- Creates a ChatGPT prompt combining location, time of day, season, and weather conditions for image generation.
### Functionality
- Retrieves the current day segment and season, and combines it with location name and weather conditions to create `chatgpt_in`.
- Processes `chatgpt_in` to generate `chatgpt_out` for use in DALL-E image generation.
- Dispatches `chatgpt_out` to update the `sensor.weathercanvasai_prompts`.

## Service: `create_dalle_image`
### Purpose
- Generates an image using DALL-E based on the ChatGPT prompt.
### Functionality
- Retrieves `chatgpt_out` from `sensor.haweathercanvasai_prompts`.
- Uses this prompt to generate an image via DALL-E.
- Updates the `camera.haweathercanvasai_image` entity with the new image URL upon successful generation.

## Usage and Integration in UI
- **Generated Image Accessibility**:
  - The last generated image by `camera.haweathercanvasai_image` is saved in the Home Assistant configuration directory under `/local`. (This is your /configuration/www directory)
  - This enables easy integration of the image into different parts of the Home Assistant UI, such as in an image card, providing dynamic visual content based on the current environmental conditions.

## Contributing
- Contributions to enhance or fix issues in this integration are welcome.


